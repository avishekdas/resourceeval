<!DOCTYPE HTML>
<html>
	<head>
		<title>Resource Evaluation & Dashboard</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/skel.min.js"></script>
		<script src="assets/js/util.js"></script>
		<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
		<script src="assets/js/main.js"></script>
		<script> 
		$(function(){
		  $("#header").load("header.html"); 
		  $("#inner1").load("footer.html"); 
		});
		</script>
	</head>
	<body>

		<!-- Wrapper -->
			<div id="wrapper">

			<!-- Main -->
				<div id="main">
					<div class="inner">

						<!-- Header -->
							<header id="header"></header>

							<!-- Content -->
								<section>
									<div id="nameInput" class="input-group-lg center-block helloInput">
									<form>
										<input id="id" name="id" type="hidden" name="id" />
										<p class="lead">Employee Number
										<input id="ibmid" name="ibmid" type="text" class="form-control" placeholder="IBM Id" aria-describedby="sizing-addon1" value="" />
										</p>
										<p></p>
										<p class="lead">Employee Name
										<input id="resourcename" name="resourcename" type="text" class="form-control" placeholder="Name" aria-describedby="sizing-addon1" value="" />
										</p>
										<p></p>
										<p class="lead">IBM email id
										<input id="email" name="email" type="text" class="form-control" placeholder="Email Address" aria-describedby="sizing-addon1" value="" />
										</p>
										<p></p>
										<p class="lead">Select Evaluator 
										<select id="evaluatorno"></select>
										</p>
										<p></p>
										<span class="inlineinput" id="techcombo"></span>
										</p>
										<p></p>
										<p class="lead">
											<table>
												<thead>
													<tr>
														<th>Technology</th>
														<th>Self Rating</th>
														<th>Evaluator Rating</th>
													</tr>
												</thead>
												<tbody>
													
												</tbody>
											</table>
										<p></p>
										<input id="save" name="save" type="button" value="SAVE" class="button"/>
										
									</form>
									</div>
									<p id="response" class="lead text-center"></p>
								</section>

						</div>
					</div>

			<!-- Sidebar -->
				<div id="sidebar">
					<div id="inner1" class="inner"></div>
				</div>

			</div>

		<!-- Scripts -->
			<script>
				$(document).ready(function(){
					var old_jsonObj = {};
					var id = getUrlVars()["id"];
					if(id != "") {
						$.getJSON('/getEvaluators', function(data){
							$.each(data.rows, function( key, obj ) {
								var s = $('#evaluatorno');
								var evaluatorDoc = obj.doc;
								var evaluators = evaluatorDoc.datavalue;
								for(var val in evaluators) {
									$('<option />', {value: evaluators[val], text: evaluators[val]}).appendTo(s);
								}
							});
							
							$.getJSON('/getRatings', function(data){
								var optionstr = '<select id="rating" class="form-control" style="display: inline;width: 20%;margin-right: 5%;">';
								$.each(data.rows, function( key, obj ) {
									var ratingDoc = obj.doc;
									var ratings = ratingDoc.datavalue;
									for(var val in ratings) {
										optionstr += '<option value="' + ratings[val] + '">' + ratings[val] + '</option>';
									}
								});
								optionstr += '</select>';
								
								var url = 'getresourcedlts?id=' + id;
								$.getJSON(url, function(result){
									old_jsonObj = result;
									$("#id").val(result._id);
									$( "#ibmid" ).val(result.ibmid);
									$( "#resourcename" ).val(result.resourcename);
									$( "#email" ).val(result.email);
									
									$.each(result.technologies, function(key, val) {
									  var me = this;
									  var tech = me.technology;
									  var selfrating = me.selfrating;
									  var row = "<tr><td>" + tech + "</td><td>" + selfrating + "</td><td>";
									  row += optionstr;
									  row += "</td></tr>";
									  $("table tbody").append(row);
									});
									
								});
							});
						});
						$("#save").click(function(){
							var jsonObj = {};
							var techarr = [];
							var table = $("table tbody");
							table.find('tr').each(function (i) {
								var $tds = $(this).find('td');
								var tech = {};
								tech.technology = $tds.eq(0).text();                             
								tech.selfrating = $tds.eq(1).text();
								if($("#evaluatorno").val() == 'Evaluator1') {
									tech.eval1rating = $tds.eq(2).find("select").val();
									tech.eval2rating = old_jsonObj.technologies[i].eval2rating;
									tech.eval3rating = old_jsonObj.technologies[i].eval3rating;
								} else if($("#evaluatorno").val() == 'Evaluator2') {
									tech.eval2rating = $tds.eq(2).find("select").val();
									tech.eval1rating = old_jsonObj.technologies[i].eval1rating;
									tech.eval3rating = old_jsonObj.technologies[i].eval3rating;
								} else if($("#evaluatorno").val() == 'Evaluator3') {
									tech.eval3rating = $tds.eq(2).find("select").val();
									tech.eval1rating = old_jsonObj.technologies[i].eval1rating;
									tech.eval2rating = old_jsonObj.technologies[i].eval2rating;
								}
								techarr.push(tech);
							});
							
							jsonObj._id = $("#id").val();
							jsonObj.ibmid = $("#ibmid").val();
							jsonObj.resourcename = $("#resourcename").val();
							jsonObj.email = $("#email").val();
							jsonObj.technologies = techarr;
							
							$.ajax({
								url: '/savedata',
								// dataType: "jsonp",
								data: jsonObj,
								type: 'POST',
								success: function (data) {
									var ret = jQuery.parseJSON(data);
									window.location.replace("success.html");
								},
								error: function (xhr, status, error) {
									var ret = jQuery.parseJSON(data);
									window.location.replace("failure.html");
								},
							});
						});
					}
				});
				
				function getUrlVars()
				{
					var vars = [], hash;
					var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
					for(var i = 0; i < hashes.length; i++)
					{
						hash = hashes[i].split('=');
						vars.push(hash[0]);
						vars[hash[0]] = hash[1];
					}
					return vars;
				}
			</script>
	</body>
</html>